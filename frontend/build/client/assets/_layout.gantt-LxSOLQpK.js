import{a as d,o as r,w as gt}from"./chunk-QMGIS6GS-CRLmNMPd.js";import{Q as mt,R as ut}from"./sdk.gen-1y8RMMdH.js";import{K as ft}from"./KojiDetailModal-BnI-BK5R.js";import"./index-BXUbddt1.js";import"./Close-XszXWwct.js";import"./useThemeProps-Q2zdfQ03.js";const wt=()=>{const[u,v]=d.useState([]),[T,V]=d.useState([]),[N,I]=d.useState(null),[G,C]=d.useState(!0),[B,F]=d.useState(null),[i,P]=d.useState(new Date),[x,k]=d.useState(new Date),[U,X]=d.useState(!1),[S,Q]=d.useState([]),[q,H]=d.useState(!1),o=d.useRef(null),[j,$]=d.useState(10),R=5,g=10,p=40,W=async()=>{try{C(!0),F(null);const e=(await mt()).data||[];v(e)}catch(t){console.error("Error loading kojies:",t),F(`å·¥äº‹ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${t instanceof Error?t.message:"Unknown error"}`)}finally{C(!1)}};d.useEffect(()=>{W(),A(!1)},[]);const[Y,A]=d.useState(!1);d.useEffect(()=>{o.current&&i&&x&&T.length>0&&!Y&&setTimeout(()=>{if(o.current){const t=(new Date().getTime()-i.getTime())/864e5*g,e=o.current.clientWidth,n=Math.max(0,t-e/2);o.current.scrollLeft=n,A(!0)}},300)},[i,x,T,Y]),d.useEffect(()=>{if(u.length===0)return;let t=new Date,e=new Date,n=!1;if(u.forEach(a=>{try{const s=a.start_date?new Date(a.start_date):null,c=a.end_date?new Date(a.end_date):null;s&&!isNaN(s.getTime())&&((!n||s<t)&&(t=s),n=!0),c&&!isNaN(c.getTime())&&((!n||c>e)&&(e=c),n=!0)}catch{}}),n){const a=new Date(t.getFullYear(),t.getMonth()-1,1),s=new Date(e.getFullYear(),e.getMonth()+1,0);P(a),k(s)}else{const a=new Date,s=new Date(a.getFullYear(),a.getMonth()-6,1),c=new Date(a.getFullYear(),a.getMonth()+6,0);P(s),k(c)}},[u]);const E=(t=0)=>{if(u.length===0||!o.current)return;const e=o.current.clientWidth,n=t/g,a=(t+e)/g,s=new Date(i.getTime()+n*24*60*60*1e3),c=new Date(i.getTime()+a*24*60*60*1e3),_=u.filter(m=>{try{const h=m.start_date?new Date(m.start_date):new Date,l=m.end_date?new Date(m.end_date):new Date(h.getTime()+90*24*60*60*1e3);return h<=c&&l>=s}catch{return!1}}).sort((m,h)=>{const l=m.start_date?new Date(m.start_date).getTime():0,f=h.start_date?new Date(h.start_date).getTime():0;return l-f});let D;if(_.length>0)D=_[0].start_date?new Date(_[0].start_date).getTime():0;else{const m=s.getTime(),h=u.filter(l=>(l.start_date?new Date(l.start_date).getTime():0)<=m);if(h.length>0){const l=h.sort((f,y)=>{const K=f.start_date?new Date(f.start_date).getTime():0;return(y.start_date?new Date(y.start_date).getTime():0)-K})[0];D=l.start_date?new Date(l.start_date).getTime():0}else{const l=[...u].sort((f,y)=>{const K=f.start_date?new Date(f.start_date).getTime():0,O=y.start_date?new Date(y.start_date).getTime():0;return K-O});if(l.length===0)return;D=l[0].start_date?new Date(l[0].start_date).getTime():0}}let b=[...u].sort((m,h)=>{const l=m.start_date?new Date(m.start_date).getTime():0,f=h.start_date?new Date(h.start_date).getTime():0;return l-f}).filter(m=>(m.start_date?new Date(m.start_date).getTime():0)>=D).slice(0,j);b.length<j&&(b=[...u].sort((h,l)=>{const f=h.start_date?new Date(h.start_date).getTime():0;return(l.start_date?new Date(l.start_date).getTime():0)-f}).slice(0,j).sort((h,l)=>{const f=h.start_date?new Date(h.start_date).getTime():0,y=l.start_date?new Date(l.start_date).getTime():0;return f-y})),Q(b)},J=()=>{o.current&&E(o.current.scrollLeft)};d.useEffect(()=>{u.length>0&&o.current&&E(o.current.scrollLeft)},[u,i,j]);const z=()=>{if(!o.current)return R;const e=o.current.clientHeight-55,n=Math.floor(e/p);return Math.max(R,n)};d.useEffect(()=>{const t=()=>{if(o.current){const e=z();$(e),E(o.current.scrollLeft)}};return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[u,i]),d.useEffect(()=>{if(o.current&&T.length>0){const t=z();$(t)}},[T.length]),d.useEffect(()=>{if(S.length===0)return;const t=S.map((e,n)=>{let a,s;try{a=e.start_date?new Date(e.start_date):new Date,isNaN(a.getTime())&&(a=new Date)}catch{a=new Date}try{s=e.end_date?new Date(e.end_date):new Date(a.getTime()+90*24*60*60*1e3),isNaN(s.getTime())&&(s=new Date(a.getTime()+90*24*60*60*1e3))}catch{s=new Date(a.getTime()+90*24*60*60*1e3)}const c=(a.getTime()-i.getTime())/(1e3*60*60*24),w=Math.max(0,c*g),D=(s.getTime()-i.getTime())/(1e3*60*60*24)*g,M=Math.max(g,D-w);return{...e,startX:isNaN(w)?0:w,width:isNaN(M)?g:M,row:n}});V(t)},[S,i]);const Z=t=>{I(t),X(!0)},tt=t=>{if(o.current)try{const e=t.start_date?new Date(t.start_date):new Date,n=t.end_date?new Date(t.end_date):new Date(e.getTime()+90*24*60*60*1e3),s=(new Date((e.getTime()+n.getTime())/2).getTime()-i.getTime())/(1e3*60*60*24)*g,c=o.current.clientWidth,w=Math.max(0,s-c/2);o.current.scrollLeft=w}catch(e){console.error("Error calculating koji center:",e)}},et=()=>{if(!o.current)return;const t=(new Date().getTime()-i.getTime())/(1e3*60*60*24)*g,e=o.current.clientWidth,n=Math.max(0,t-e/2);o.current.scrollLeft=n},at=async t=>{try{const e=await ut({body:t});if(e.data)return v(n=>n.map(a=>a.path===e.data.path?e.data:a)),e.data;throw new Error("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ")}catch(e){throw console.error("Error updating koji:",e),e}},nt=t=>{I(t),N&&N.path!==t.path&&H(!0),v(e=>{const n=e.findIndex(a=>a.path===t.path);if(n!==-1){const a=[...e];return a[n]=t,a}else{const a=e.findIndex(s=>N&&s.path===N.path);if(a!==-1){const s=[...e];return s.splice(a,1),s.push(t),s.sort((c,w)=>{const _=c.start_date?new Date(typeof c.start_date=="string"?c.start_date:c.start_date["time.Time"]).getTime():0,D=w.start_date?new Date(typeof w.start_date=="string"?w.start_date:w.start_date["time.Time"]).getTime():0;return _>0&&D===0?-1:_===0&&D>0?1:_>0&&D>0?_-D:(c.name||"").localeCompare(w.name||"")})}else return[...e,t]}})},st=t=>{switch(t){case"é€²è¡Œä¸­":return"#4CAF50";case"å®Œäº†":return"#9E9E9E";case"äºˆå®š":return"#FF9800";default:return"#2196F3"}},rt=t=>!t.managed_files||t.managed_files.length===0?!1:t.managed_files.some(n=>n.current&&n.recommended&&n.current!==n.recommended),ot=()=>{const t=[],e=new Date(i);for(;e<=x;){const n=new Date(e.getFullYear(),e.getMonth(),1),s=new Date(e.getFullYear(),e.getMonth()+1,0).getDate();t.push({year:n.getFullYear(),month:n.getMonth()+1,width:s*g,startX:(n.getTime()-i.getTime())/(1e3*60*60*24)*g}),e.setMonth(e.getMonth()+1)}return t},it=()=>{const t=[],e=new Date(i);for(;e<=x;){const n=e.getDate();(n===1||n%3===1)&&n!==31&&t.push({date:n,month:e.getMonth()+1,year:e.getFullYear(),startX:(e.getTime()-i.getTime())/(1e3*60*60*24)*g,width:g*3}),e.setDate(e.getDate()+1)}return t},ct=()=>{const t=[],e=new Date(i.getFullYear(),i.getMonth()+1,1);for(;e<=x;){const n=(e.getTime()-i.getTime())/864e5*g;t.push({startX:n,year:e.getFullYear(),month:e.getMonth()+1}),e.setMonth(e.getMonth()+1)}return t};if(G)return r.jsx("div",{className:"loading",children:"å·¥äº‹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­..."});if(B)return r.jsx("div",{className:"error",children:B});const lt=ot(),L=it(),dt=ct(),ht=(x.getTime()-i.getTime())/(1e3*60*60*24)*g;return r.jsxs("div",{className:"gantt-container",children:[r.jsxs("div",{style:{marginBottom:"20px",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[r.jsx("button",{onClick:et,className:"gantt-today-button",children:"ðŸ“… ä»Šæ—¥ã¸ç§»å‹•"}),r.jsxs("div",{style:{fontSize:"16px",color:"#666",fontWeight:"500"},children:["è¡¨ç¤ºä¸­: ",T.length,"ä»¶ / å…¨",u.length,"ä»¶"]})]}),r.jsxs("div",{className:"gantt-wrapper",children:[r.jsxs("div",{className:"gantt-sidebar",children:[r.jsx("div",{className:"gantt-header-left",children:"ä¼šç¤¾å"}),T.map((t,e)=>{const n=new Date;let a,s;try{a=t.start_date?new Date(t.start_date):new Date,isNaN(a.getTime())&&(a=new Date)}catch{a=new Date}try{s=t.end_date?new Date(t.end_date):new Date(a.getTime()+90*24*60*60*1e3),isNaN(s.getTime())&&(s=new Date(a.getTime()+90*24*60*60*1e3))}catch{s=new Date(a.getTime()+90*24*60*60*1e3)}const c=n>=a&&n<=s;return r.jsx("div",{className:`gantt-row-label ${c?"gantt-row-label-active":""}`,style:{height:p},children:r.jsx("div",{className:`koji-name koji-name-clickable ${c?"koji-name-active":""}`,onClick:()=>tt(t),title:"ã‚¯ãƒªãƒƒã‚¯ã—ã¦å·¥äº‹æœŸé–“ã®ä¸­å¤®ã«ç§»å‹•",children:t.company_name})},`${t.id}-${e}`)})]}),r.jsx("div",{className:"gantt-chart-container",ref:o,onScroll:J,style:{backgroundColor:"#f5f5f5"},children:r.jsxs("div",{className:"gantt-chart",style:{width:ht,backgroundColor:"#f5f5f5"},children:[r.jsx("div",{className:"gantt-header month-header-row",style:{height:"30px"},children:lt.map((t,e)=>r.jsxs("div",{className:"month-header month-header-content",style:{left:t.startX,width:t.width},children:[t.year,"å¹´",t.month,"æœˆ"]},e))}),r.jsx("div",{className:"gantt-header day-header-row",style:{height:"25px",borderBottom:"1px solid #333"},children:L.map((t,e)=>r.jsx("div",{className:"day-header day-header-content",style:{left:t.startX,width:t.width},children:t.date},e))}),r.jsx("div",{className:"gantt-month-boundaries",style:{top:0,height:"100%"},children:dt.map((t,e)=>r.jsx("div",{className:"month-boundary-line",style:{left:t.startX,top:0,height:Math.max(400,j*p+55)},title:`${t.year}å¹´${t.month}æœˆé–‹å§‹`},`month-boundary-${e}`))}),r.jsxs("div",{className:"gantt-body",children:[r.jsx("div",{className:"gantt-grid",children:L.map((t,e)=>r.jsx("div",{className:"grid-line",style:{left:t.startX,height:Math.max(400,j*p)}},e))}),r.jsx("div",{className:"gantt-horizontal-grid",children:T.map((t,e)=>r.jsx("div",{className:"horizontal-grid-line",style:{top:(e+1)*p,width:"100%"}},`horizontal-${e}`))}),T.map((t,e)=>r.jsxs("div",{className:"gantt-bar",style:{left:t.startX,width:t.width,top:e*p+10,height:p-15,backgroundColor:st(t.status)},onClick:()=>Z(t),title:`${t.company_name} - ${t.location_name} (ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç·¨é›†)`,children:[r.jsx("span",{className:"gantt-bar-text",children:t.location_name}),rt(t)&&r.jsx("span",{className:"gantt-bar-rename-indicator",title:"ç®¡ç†ãƒ•ã‚¡ã‚¤ãƒ«ã®åå‰å¤‰æ›´ãŒå¿…è¦ã§ã™",children:"âš ï¸"})]},`${t.id}-${e}`)),r.jsx("div",{className:"today-area",style:{left:Math.floor((new Date().setHours(0,0,0,0)-i.getTime())/(1e3*60*60*24))*g,width:g,height:Math.max(400,j*p),backgroundColor:"rgba(255, 192, 203, 0.3)",position:"absolute",top:0,pointerEvents:"none",zIndex:1}})]})]})})]}),r.jsx(ft,{isOpen:U,onClose:()=>{X(!1),q&&(W(),H(!1))},koji:N,onUpdate:at,onKojiUpdate:nt})]})},Nt=gt(function(){return r.jsx(wt,{})});export{Nt as default};
