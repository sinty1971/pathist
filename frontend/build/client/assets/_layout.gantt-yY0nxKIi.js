import{a as g,o as r,w as it}from"./chunk-QMGIS6GS-CRLmNMPd.js";import{R as ct}from"./sdk.gen-C0JJsBdk.js";import{P as dt}from"./ProjectDetailModal-BfP-5M3c.js";import"./index-BXUbddt1.js";const lt=()=>{const[u,N]=g.useState([]),[j,z]=g.useState([]),[x,C]=g.useState(null),[L,F]=g.useState(!0),[I,B]=g.useState(null),[i,R]=g.useState(new Date),[T,k]=g.useState(new Date),[gt,ht]=g.useState(!1),[H,W]=g.useState(!1),[v,O]=g.useState([]),d=g.useRef(null),S=10,h=10,y=40,V=async()=>{try{F(!0),B(null),console.log("Loading projects...");const t=await ct();console.log("API response:",t);const e=t.data||[];console.log("Projects:",e),N(e)}catch(t){console.error("Error loading projects:",t),B(`工事データの読み込みに失敗しました: ${t instanceof Error?t.message:"Unknown error"}`)}finally{F(!1)}};g.useEffect(()=>{V(),A(!1)},[]);const[X,A]=g.useState(!1);g.useEffect(()=>{d.current&&i&&T&&j.length>0&&!X&&setTimeout(()=>{if(d.current){const t=(new Date().getTime()-i.getTime())/864e5*h,e=d.current.clientWidth,n=Math.max(0,t-e/2);d.current.scrollLeft=n,A(!0)}},300)},[i,T,j,X]),g.useEffect(()=>{if(u.length===0)return;let t=new Date,e=new Date,n=!1;if(u.forEach(a=>{try{const s=a.start_date?new Date(a.start_date):null,o=a.end_date?new Date(a.end_date):null;s&&!isNaN(s.getTime())&&((!n||s<t)&&(t=s),n=!0),o&&!isNaN(o.getTime())&&((!n||o>e)&&(e=o),n=!0)}catch{}}),n){const a=new Date(t.getFullYear(),t.getMonth()-1,1),s=new Date(e.getFullYear(),e.getMonth()+1,0);R(a),k(s)}else{const a=new Date,s=new Date(a.getFullYear(),a.getMonth()-6,1),o=new Date(a.getFullYear(),a.getMonth()+6,0);R(s),k(o)}},[u]);const E=(t=0)=>{if(u.length===0||!d.current)return;const e=d.current.clientWidth,n=t/h,a=(t+e)/h,s=new Date(i.getTime()+n*24*60*60*1e3),o=new Date(i.getTime()+a*24*60*60*1e3),p=u.filter(m=>{try{const l=m.start_date?new Date(m.start_date):new Date,c=m.end_date?new Date(m.end_date):new Date(l.getTime()+90*24*60*60*1e3);return l<=o&&c>=s}catch{return!1}}).sort((m,l)=>{const c=m.start_date?new Date(m.start_date).getTime():0,f=l.start_date?new Date(l.start_date).getTime():0;return c-f});let D;if(p.length>0)D=p[0].start_date?new Date(p[0].start_date).getTime():0;else{const m=s.getTime(),l=u.filter(c=>(c.start_date?new Date(c.start_date).getTime():0)<=m);if(l.length>0){const c=l.sort((f,_)=>{const M=f.start_date?new Date(f.start_date).getTime():0;return(_.start_date?new Date(_.start_date).getTime():0)-M})[0];D=c.start_date?new Date(c.start_date).getTime():0}else{const c=[...u].sort((f,_)=>{const M=f.start_date?new Date(f.start_date).getTime():0,$=_.start_date?new Date(_.start_date).getTime():0;return M-$});if(c.length===0)return;D=c[0].start_date?new Date(c[0].start_date).getTime():0}}let P=[...u].sort((m,l)=>{const c=m.start_date?new Date(m.start_date).getTime():0,f=l.start_date?new Date(l.start_date).getTime():0;return c-f}).filter(m=>(m.start_date?new Date(m.start_date).getTime():0)>=D).slice(0,S);P.length<S&&(P=[...u].sort((l,c)=>{const f=l.start_date?new Date(l.start_date).getTime():0;return(c.start_date?new Date(c.start_date).getTime():0)-f}).slice(0,S).sort((l,c)=>{const f=l.start_date?new Date(l.start_date).getTime():0,_=c.start_date?new Date(c.start_date).getTime():0;return f-_})),O(P)},G=()=>{d.current&&E(d.current.scrollLeft)};g.useEffect(()=>{u.length>0&&d.current&&E(d.current.scrollLeft)},[u,i]),g.useEffect(()=>{const t=()=>{d.current&&E(d.current.scrollLeft)};return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[u,i]),g.useEffect(()=>{if(v.length===0)return;const t=v.map((e,n)=>{let a,s;try{a=e.start_date?new Date(e.start_date):new Date,isNaN(a.getTime())&&(a=new Date)}catch{a=new Date}try{s=e.end_date?new Date(e.end_date):new Date(a.getTime()+90*24*60*60*1e3),isNaN(s.getTime())&&(s=new Date(a.getTime()+90*24*60*60*1e3))}catch{s=new Date(a.getTime()+90*24*60*60*1e3)}const o=(a.getTime()-i.getTime())/(1e3*60*60*24),w=Math.max(0,o*h),D=(s.getTime()-i.getTime())/(1e3*60*60*24)*h,b=Math.max(h,D-w);return{...e,startX:isNaN(w)?0:w,width:isNaN(b)?h:b,row:n}});z(t)},[v,i]);const U=t=>{C(t),W(!0)},J=t=>{if(d.current)try{const e=t.start_date?new Date(t.start_date):new Date,n=t.end_date?new Date(t.end_date):new Date(e.getTime()+90*24*60*60*1e3),s=(new Date((e.getTime()+n.getTime())/2).getTime()-i.getTime())/(1e3*60*60*24)*h,o=d.current.clientWidth,w=Math.max(0,s-o/2);d.current.scrollLeft=w}catch(e){console.error("Error calculating project center:",e)}},q=()=>{if(!d.current)return;const t=(new Date().getTime()-i.getTime())/(1e3*60*60*24)*h,e=d.current.clientWidth,n=Math.max(0,t-e/2);d.current.scrollLeft=n},K=async t=>{try{const e=await fetch("http://localhost:8080/api/project/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok){const a=await e.json();throw new Error(a.message||"更新に失敗しました")}const n=await e.json();return N(a=>a.map(s=>s.id===n.id?n:s)),n}catch(e){throw console.error("Error updating project:",e),e}},Q=t=>{N(e=>{const n=e.findIndex(a=>a.id===t.id);if(n!==-1){const a=[...e];return a[n]=t,a}if(x&&x.id!==t.id){const a=e.findIndex(s=>s.id===x.id);if(a!==-1){const s=[...e];return s.splice(a,1),s.push(t),s.sort((o,w)=>{const p=o.start_date?new Date(typeof o.start_date=="string"?o.start_date:o.start_date["time.Time"]).getTime():0,D=w.start_date?new Date(typeof w.start_date=="string"?w.start_date:w.start_date["time.Time"]).getTime():0;return p>0&&D===0?-1:p===0&&D>0?1:p>0&&D>0?p-D:(o.name||"").localeCompare(w.name||"")})}}return[...e,t]}),C(t)},Z=t=>{switch(t){case"進行中":return"#4CAF50";case"完了":return"#9E9E9E";case"予定":return"#FF9800";default:return"#2196F3"}},tt=t=>!t.managed_files||t.managed_files.length===0?!1:t.managed_files.some(n=>n.current&&n.recommended&&n.current!==n.recommended),et=()=>{const t=[],e=new Date(i);for(;e<=T;){const n=new Date(e.getFullYear(),e.getMonth(),1),s=new Date(e.getFullYear(),e.getMonth()+1,0).getDate();t.push({year:n.getFullYear(),month:n.getMonth()+1,width:s*h,startX:(n.getTime()-i.getTime())/(1e3*60*60*24)*h}),e.setMonth(e.getMonth()+1)}return t},at=()=>{const t=[],e=new Date(i);for(;e<=T;){const n=e.getDate();(n===1||n%3===1)&&t.push({date:n,month:e.getMonth()+1,year:e.getFullYear(),startX:(e.getTime()-i.getTime())/(1e3*60*60*24)*h,width:h*3}),e.setDate(e.getDate()+1)}return t},nt=()=>{const t=[],e=new Date(i.getFullYear(),i.getMonth()+1,1);for(;e<=T;){const n=(e.getTime()-i.getTime())/864e5*h;t.push({startX:n,year:e.getFullYear(),month:e.getMonth()+1}),e.setMonth(e.getMonth()+1)}return t};if(L)return r.jsx("div",{className:"loading",children:"工事データを読み込み中..."});if(I)return r.jsx("div",{className:"error",children:I});const st=et(),Y=at(),rt=nt(),ot=(T.getTime()-i.getTime())/(1e3*60*60*24)*h;return r.jsxs("div",{className:"gantt-container",children:[r.jsx("h1",{children:"工程表"}),r.jsxs("div",{className:"gantt-controls",children:[r.jsx("button",{onClick:q,style:{padding:"8px 16px",background:"#FF5252",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"14px"},children:"今日へ移動"}),r.jsx("div",{className:"info",children:r.jsxs("span",{children:["表示中: ",j.length,"件 / 全",u.length,"件"]})})]}),r.jsxs("div",{className:"gantt-wrapper",children:[r.jsxs("div",{className:"gantt-sidebar",children:[r.jsx("div",{className:"gantt-header-left",children:"工事名"}),j.map((t,e)=>{const n=new Date;let a,s;try{a=t.start_date?new Date(t.start_date):new Date,isNaN(a.getTime())&&(a=new Date)}catch{a=new Date}try{s=t.end_date?new Date(t.end_date):new Date(a.getTime()+90*24*60*60*1e3),isNaN(s.getTime())&&(s=new Date(a.getTime()+90*24*60*60*1e3))}catch{s=new Date(a.getTime()+90*24*60*60*1e3)}const o=n>=a&&n<=s;return r.jsx("div",{className:"gantt-row-label",style:{height:y,backgroundColor:o?"#fff3cd":"transparent",borderLeft:o?"4px solid #ffc107":"none"},children:r.jsxs("div",{className:"project-name",style:{fontWeight:o?"bold":"normal",color:o?"#856404":"inherit",cursor:"pointer"},onClick:()=>J(t),title:"クリックしてプロジェクト期間の中央に移動",children:[t.company_name," - ",t.location_name]})},`${t.id}-${e}`)})]}),r.jsx("div",{className:"gantt-chart-container",ref:d,onScroll:G,style:{backgroundColor:"#f5f5f5"},children:r.jsxs("div",{className:"gantt-chart",style:{width:ot,backgroundColor:"#f5f5f5"},children:[r.jsx("div",{className:"gantt-header month-header-row",style:{height:"30px"},children:st.map((t,e)=>r.jsxs("div",{className:"month-header",style:{position:"absolute",left:t.startX,width:t.width,height:"100%",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#e8f4fd",borderRight:"1px solid #ddd",fontWeight:"bold",fontSize:"13px",color:"#0066cc"},children:[t.year,"年",t.month,"月"]},e))}),r.jsx("div",{className:"gantt-header day-header-row",style:{height:"25px",borderBottom:"2px solid #333"},children:Y.map((t,e)=>r.jsx("div",{className:"day-header",style:{position:"absolute",left:t.startX,width:t.width,height:"100%",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#f5f5f5",borderRight:"1px solid #ddd",fontSize:"11px",fontWeight:"500"},children:t.date},e))}),r.jsxs("div",{className:"gantt-body",children:[r.jsx("div",{className:"gantt-grid",children:Y.map((t,e)=>r.jsx("div",{className:"grid-line",style:{left:t.startX}},e))}),r.jsx("div",{className:"gantt-month-boundaries",children:rt.map((t,e)=>r.jsx("div",{className:"month-boundary-line",style:{left:t.startX},title:`${t.year}年${t.month}月開始`},`month-boundary-${e}`))}),r.jsx("div",{className:"gantt-horizontal-grid",children:j.map((t,e)=>r.jsx("div",{className:"horizontal-grid-line",style:{top:(e+1)*y,width:"100%"}},`horizontal-${e}`))}),j.map((t,e)=>r.jsxs("div",{className:"gantt-bar",style:{left:t.startX,width:t.width,top:e*y+5,height:y-10,backgroundColor:Z(t.status)},onClick:()=>U(t),title:`${t.company_name} - ${t.location_name} (クリックして編集)`,children:[r.jsx("span",{className:"gantt-bar-text",children:t.location_name}),tt(t)&&r.jsx("span",{className:"gantt-bar-rename-indicator",title:"管理ファイルの名前変更が必要です",children:"⚠️"})]},`${t.id}-${e}`)),r.jsx("div",{className:"today-area",style:{left:Math.floor((new Date().setHours(0,0,0,0)-i.getTime())/(1e3*60*60*24))*h,width:h,height:"100%",backgroundColor:"rgba(255, 192, 203, 0.3)",position:"absolute",top:0,pointerEvents:"none",zIndex:1}})]})]})})]}),r.jsx(dt,{isOpen:H,onClose:()=>W(!1),project:x,onUpdate:K,onProjectUpdate:Q})]})},pt=it(function(){return r.jsx("div",{className:"container mx-auto p-4",children:r.jsx("div",{className:"bg-white border border-gray-200 rounded-lg",children:r.jsx("div",{className:"p-6",children:r.jsx(lt,{})})})})});export{pt as default};
